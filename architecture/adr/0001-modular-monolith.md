# ADR-0001: 采用模块化单体架构

## 状态

已采纳 (Accepted)

## 背景

我们正在构建一个数据处理平台，需要支持：
- 多种数据源连接 (MySQL/MongoDB/Redis/Milvus/达梦)
- 数据处理与转换
- LLM 智能处理
- 数据治理

团队规模较小，需要快速迭代验证产品。

## 决策

**采用模块化单体架构 (Modular Monolith)**，而非微服务架构。

### 架构特点

```
ai-workbench/
├── packages/           # 共享模块 (可独立发布)
│   ├── connectors/    # 数据源连接器
│   ├── metadata/      # 元数据模型
│   └── llm/           # LLM 客户端
│
└── services/          # 服务模块 (单进程部署)
    ├── api/           # REST API
    ├── worker/        # 任务执行器
    └── scheduler/     # 调度器
```

### 模块边界规则

1. **packages/** 下的模块可被任意服务依赖
2. **services/** 下的模块不能相互直接依赖，通过消息/API 通信
3. 每个模块有独立的测试和文档

## 理由

### 选择模块化单体的原因

| 考量 | 微服务 | 模块化单体 | 结论 |
|------|--------|-----------|------|
| 开发复杂度 | 高 | 低 | ✅ 单体更简单 |
| 运维成本 | 高 | 低 | ✅ 单体更省事 |
| 调试难度 | 高 | 低 | ✅ 单体更易调试 |
| 团队规模要求 | 大 | 小 | ✅ 适合小团队 |
| 迭代速度 | 慢 | 快 | ✅ 快速验证 |
| 后期拆分 | - | 可行 | ✅ 保留拆分能力 |

### 保留拆分能力的关键

1. **模块边界清晰**: services 之间不直接调用
2. **数据隔离**: 各模块使用独立的数据库 Schema
3. **接口稳定**: 模块间通过定义良好的接口通信
4. **独立测试**: 每个模块可独立测试

## 后果

### 正面

- 开发效率高，快速迭代
- 运维简单，单进程部署
- 调试方便，本地可完整运行
- 事务处理简单

### 负面

- 单点故障风险 (可通过多实例缓解)
- 无法独立扩展单个模块
- 技术栈统一 (都是 Python)

### 风险缓解

- **单点故障**: 部署多个实例 + 负载均衡
- **扩展瓶颈**: Worker 可横向扩展，API 无状态可扩展
- **后期拆分**: 保持模块边界，必要时可拆分

## 参考

- [MonolithFirst](https://martinfowler.com/bliki/MonolithFirst.html) - Martin Fowler
- [Modular Monolith](https://www.kamilgrzybek.com/design/modular-monolith-primer/) - Kamil Grzybek
