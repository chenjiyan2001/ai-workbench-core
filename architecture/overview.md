# 架构概述

## 项目定位

AI Workbench Core 是一个数据处理平台，提供：
- 多数据源统一接入 (MySQL/MongoDB/Redis/Milvus/达梦)
- 数据处理与转换
- 数据治理 (元数据/血缘/质量)
- LLM 智能处理 (打标/摘要/抽取)

## 架构原则

### 1. 模块化单体优先

```
初期采用模块化单体架构:
- 快速迭代，降低复杂度
- 模块边界清晰，便于后续拆分
- 共享基础设施，减少运维成本
```

### 2. 配置驱动

```
所有关键行为通过配置控制:
- 连接器配置 (configs/connectors/)
- 任务定义 (configs/jobs/)
- 质量规则 (configs/quality/)
- Prompt 模板 (configs/llm/)
```

### 3. 可观测性内置

```
日志/指标/追踪 作为一等公民:
- 结构化日志 (structlog)
- 指标监控 (Prometheus)
- 链路追踪 (OpenTelemetry)
```

## 分层架构

```
┌─────────────────────────────────────────────────────────────┐
│                      服务层 (API)                            │
│  FastAPI / REST API / 控制台                                 │
├─────────────────────────────────────────────────────────────┤
│                      业务层 (Services)                       │
│  任务编排 / 数据处理 / LLM 服务 / 治理服务                    │
├─────────────────────────────────────────────────────────────┤
│                      领域层 (Domain)                         │
│  连接器 / 元数据 / 质量规则 / 血缘                            │
├─────────────────────────────────────────────────────────────┤
│                      基础设施层 (Infrastructure)             │
│  数据库 / 缓存 / 消息队列 / 外部服务                          │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块

### 1. 连接器 (Connectors)

```python
# 统一的连接器接口
class Connector(ABC):
    def ping(self) -> bool: ...
    def discover(self) -> Schema: ...
    def read(self, spec: ReadSpec) -> Iterator[Record]: ...
    def write(self, spec: WriteSpec, records: Iterator[Record]) -> WriteResult: ...
```

**支持的数据源**:
- MySQL / 达梦 (关系型)
- MongoDB (文档型)
- Redis (缓存/队列)
- Milvus (向量)

### 2. 任务编排 (Orchestration)

```yaml
# 任务定义示例
name: daily_sync
schedule: "0 2 * * *"
steps:
  - name: extract
    connector: mysql_prod
    operation: read
    config:
      query: "SELECT * FROM orders WHERE date = '${date}'"

  - name: transform
    type: python
    script: transforms/clean_orders.py

  - name: load
    connector: mongodb_warehouse
    operation: write
    config:
      collection: orders_cleaned
```

### 3. LLM 服务 (LLM Service)

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   输入队列   │────▶│   LLM 处理   │────▶│   输出存储   │
│  (任务分发)  │     │  (打标/摘要)  │     │  (结果回写)  │
└──────────────┘     └──────────────┘     └──────────────┘
                            │
                            ▼
                     ┌──────────────┐
                     │   HITL 队列  │
                     │  (人工审核)   │
                     └──────────────┘
```

### 4. 数据治理 (Governance)

```
元数据目录
├── 数据源注册
├── 表/集合/向量集合 发现
├── 字段级元数据
└── 标签与分类

血缘追踪
├── 任务级血缘 (v1)
└── 字段级血缘 (v2, 规划中)

质量管理
├── 规则定义 (Great Expectations)
├── 检查执行
└── 报告生成
```

## 数据流

### 数据同步流程

```
数据源                    平台                     目标
┌──────┐              ┌─────────┐              ┌──────┐
│MySQL │──── CDC ────▶│ 同步任务 │──── Write ──▶│Mongo │
└──────┘              └─────────┘              └──────┘
                           │
                           ▼
                      ┌─────────┐
                      │元数据记录│
                      │血缘更新  │
                      └─────────┘
```

### LLM 处理流程

```
输入数据                  处理流程                  输出数据
┌──────┐              ┌─────────────┐              ┌──────┐
│ 原文 │──── 切分 ───▶│Embedding生成│──── 存储 ───▶│Milvus│
└──────┘              └─────────────┘              └──────┘
    │
    ▼
┌──────┐              ┌─────────────┐              ┌──────┐
│ 原文 │──── LLM ────▶│  打标/摘要  │──── 回写 ───▶│ MySQL│
└──────┘              └─────────────┘              └──────┘
                           │
                           ▼
                      ┌─────────┐
                      │调用记录  │
                      │成本统计  │
                      └─────────┘
```

## 技术选型

| 层次 | 技术 | 说明 |
|------|------|------|
| 语言 | Python 3.11+ | 主要开发语言 |
| API | FastAPI | Web 框架 |
| 编排 | Prefect | 任务调度 |
| 缓存 | Redis | 缓存/队列/锁 |
| 元数据存储 | PostgreSQL | 平台元数据 |
| 配置 | Pydantic | 配置校验 |
| 日志 | structlog | 结构化日志 |
| 监控 | Prometheus + Grafana | 指标监控 |

## 部署架构

### 开发环境

```
本地开发:
- Docker Compose 启动依赖服务
- Python venv 运行应用
- SQLite 作为元数据存储 (可选)
```

### 生产环境

```
┌─────────────────────────────────────────────────────────────┐
│                         负载均衡                            │
└─────────────────────────────────────────────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│   API 节点   │      │   API 节点   │      │  Worker 节点  │
│  (FastAPI)   │      │  (FastAPI)   │      │  (Prefect)   │
└──────────────┘      └──────────────┘      └──────────────┘
        │                     │                     │
        └─────────────────────┼─────────────────────┘
                              │
        ┌─────────────────────┼─────────────────────┐
        ▼                     ▼                     ▼
┌──────────────┐      ┌──────────────┐      ┌──────────────┐
│  PostgreSQL  │      │    Redis     │      │    Milvus    │
│  (元数据)    │      │  (缓存/队列)  │      │   (向量)     │
└──────────────┘      └──────────────┘      └──────────────┘
```

## 扩展点

### 新增连接器

1. 实现 `Connector` 接口
2. 注册到连接器工厂
3. 添加配置 Schema

### 新增 LLM 任务类型

1. 定义任务 Spec
2. 实现处理逻辑
3. 配置 Prompt 模板

### 新增质量规则

1. 定义规则配置
2. 实现检查逻辑
3. 注册到规则引擎

## 相关文档

- [Git 规范](../development/git.md)
- [Python 规范](../development/python.md)
- [MySQL 规范](../database/mysql.md)
- [LLM 调用规范](../integration/llm.md)
- [架构决策记录](./adr/)
