# 变更日志规范

本文档定义变更日志（CHANGELOG）的撰写规范，基于 [Keep a Changelog](https://keepachangelog.com/) 原则。

---

## 基本原则

1. **为人而写**：变更日志是给人看的，不是给机器解析的
2. **每个版本一个条目**：按版本分组，最新版本在最前
3. **按类型分类**：新增、修复、变更、移除等
4. **包含日期**：每个版本标注发布日期
5. **链接可追溯**：关联 issue、PR、commit

---

## 版本号规则 (SemVer)

```
格式: v<major>.<minor>.<patch>
```

| 版本位 | 变更类型 | 何时递增 | 示例 |
|--------|---------|---------|------|
| major (X) | 重大变更 | 不兼容的 API 修改 | v1.0.0 → v2.0.0 |
| minor (Y) | 新功能 | 向下兼容的功能新增 | v1.0.0 → v1.1.0 |
| patch (Z) | Bug 修复 | 向下兼容的问题修复 | v1.0.0 → v1.0.1 |

### 预发布版本

```
v1.0.0-alpha.1   # 内测版
v1.0.0-beta.1    # 公测版
v1.0.0-rc.1      # 发布候选
v1.0.0           # 正式版
```

### [Unreleased] 章节

用于记录尚未发版的变更，发版时移动到新版本条目：

```markdown
## [Unreleased]

### ✨ 新增 (Added)
- 添加用户导出功能

### 🐛 修复 (Fixed)
- 修复登录超时问题
```

发版时操作：
1. 将 `[Unreleased]` 下的内容移动到新版本条目
2. 清空 `[Unreleased]` 章节（保留标题）
3. 打 tag 并提交

---

## 变更类型标签

| 标签 | 含义 | 使用场景 |
|------|------|---------|
| ✨ Added | 新增功能 | 新功能、新文件、新模块 |
| 🐛 Fixed | Bug 修复 | 修复已知问题 |
| 🔧 Changed | 功能变更 | 修改现有功能行为 |
| 🗑️ Removed | 移除功能 | 删除功能或文件 |
| ⚠️ Deprecated | 即将废弃 | 标记将在未来版本移除的功能 |
| 🔒 Security | 安全修复 | 修复安全漏洞 |
| 📁 Files | 涉及文件 | 列出本次变更涉及的文件 |
| 💬 Notes | 备注说明 | 补充说明信息 |

---

## 变更日志模板

### 标准模板

```markdown
### [vX.Y.Z] - YYYY-MM-DD

#### 📋 变更摘要
一句话描述本次变更的核心内容。

#### ✨ 新增 (Added)
- 新增功能或文件

#### 🐛 修复 (Fixed)
- 修复的 Bug

#### 🔧 变更 (Changed)
- 修改的现有功能

#### 🗑️ 移除 (Removed)
- 删除的功能或文件

#### 📁 涉及文件
```
path/to/file1.py
path/to/file2.py
```

#### 💬 备注
补充说明（可选）。
```

### 简化模板（小版本）

```markdown
### [vX.Y.Z] - YYYY-MM-DD

#### 📋 变更摘要
修复 xxx 问题。

#### 🐛 修复 (Fixed)
- 修复 xxx 导致的 yyy 问题
```

---

## 撰写规范

### 条目格式

```markdown
# ✅ 正确：动词开头，描述变更内容
- 添加用户导出功能，支持 CSV 和 Excel 格式
- 修复并发情况下的数据竞态问题
- 移除废弃的 legacy_api 模块

# ❌ 错误：过于笼统
- 更新了一些东西
- 修复 bug
- 改进性能
```

### 关联 Issue/PR

```markdown
#### 🐛 修复 (Fixed)
- 修复登录超时问题 (#123)
- 修复数据导出乱码 (PR #456)
```

### 破坏性变更标注

```markdown
#### 🔧 变更 (Changed)
- **BREAKING**: 用户接口返回格式从数组改为分页对象
  - 迁移方法：将 `response` 改为 `response.data`
```

---

## 文件位置

本项目变更日志位置：

```
docs/upgrades/git-upgrades.md
```

---

## Claude/Codex 分工

| 角色 | 职责 |
|------|------|
| Claude | 代码开发、执行 git 操作 |
| Codex | 编写变更日志内容 |
| Claude | 提交变更日志、打 tag |

### 流程

```
1. Claude 完成代码开发和提交
2. Claude 调用 Codex 编写变更日志
3. Codex 返回 markdown 内容
4. Claude 插入到 git-upgrades.md
5. Claude 提交变更日志
6. Claude 打 tag（tag 必须在变更日志提交之后）
```

**重要**：变更日志必须在打 tag 之前完成并提交，确保 tag 对应的版本包含完整的变更记录。

---

## 完整文件骨架

新项目的变更日志文件应按以下结构组织：

```markdown
# 变更日志

本文档记录项目的所有重要变更，格式基于 [Keep a Changelog](https://keepachangelog.com/)。

---

## [Unreleased]

### ✨ 新增 (Added)
- 待发布的新功能

---

## [v1.1.0] - 2025-01-15

### 📋 变更摘要
添加数据导出功能，修复若干问题。

### ✨ 新增 (Added)
- 添加 CSV/Excel 导出功能

### 🐛 修复 (Fixed)
- 修复数据分页显示错误 (#45)

---

## [v1.0.0] - 2025-01-01

### 📋 变更摘要
首次正式发布。

### ✨ 新增 (Added)
- 核心数据处理功能
- 用户认证模块
- API 接口 v1

---

[Unreleased]: https://github.com/org/repo/compare/v1.1.0...HEAD
[v1.1.0]: https://github.com/org/repo/compare/v1.0.0...v1.1.0
[v1.0.0]: https://github.com/org/repo/releases/tag/v1.0.0
```

**说明**：
- 最新版本在最前，时间倒序排列
- 底部的链接引用便于跳转到对应 diff/release
- `[Unreleased]` 始终保留在顶部

---

## 何时更新变更日志

| 场景 | 是否更新 | 说明 |
|------|---------|------|
| 打 tag 发版 | ✅ 是 | 必须记录 |
| 重要功能合并 | ✅ 是 | 建议记录 |
| Bug 修复 | ✅ 是 | 建议记录 |
| 日常小修订 | ❌ 否 | typo、格式调整等 |
| 仅文档更新 | ❌ 否 | 除非是重要文档 |

---

## 检查清单

- [ ] 版本号符合 SemVer 规范
- [ ] 日期格式正确 (YYYY-MM-DD)
- [ ] 变更摘要简明扼要
- [ ] 变更条目按类型分类
- [ ] 破坏性变更有明确标注
- [ ] 关联了相关 issue/PR（如有）
- [ ] 涉及文件列表完整
