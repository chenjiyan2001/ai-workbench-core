# Git Claude 行为规范

本文档定义 Claude 执行 Git 操作的行为准则。基础规范见 [git.md](git.md)，操作指南见 [git-operations.md](git-operations.md)。

---

## 操作权限矩阵

### 危险等级说明

| 等级 | 标识 | 含义 | Claude 行为 |
|------|------|------|-------------|
| 🟢 安全 | SAFE | 只读或可撤销 | 直接执行，无需确认 |
| 🟡 谨慎 | CAUTION | 有副作用但可恢复 | 执行前简要说明 |
| 🔴 危险 | DANGER | 不可逆或影响他人 | **必须用户确认后执行** |
| ⛔ 禁止 | FORBIDDEN | 高风险操作 | **拒绝执行，解释原因并提供替代方案** |

### 操作权限速查表

| 操作 | 等级 | 条件 | Claude 行为 |
|------|------|------|-------------|
| `git status/diff/log/branch` | 🟢 | 无 | 直接执行 |
| `git fetch` | 🟢 | 无 | 直接执行 |
| `git reflog` | 🟢 | 无 | 直接执行 |
| `git stash list/show` | 🟢 | 无 | 直接执行 |
| `git clean -n` | 🟢 | 仅预览 | 直接执行 |
| `git add` | 🟡 | 无 | 说明后执行 |
| `git checkout -b` | 🟡 | 无 | 说明后执行 |
| `git stash push` | 🟡 | 无 | 说明后执行 |
| `git restore` | 🟡 | 无 | 说明改动将丢失 |
| `git pull --ff-only` | 🟡 | 无 | 说明后执行 |
| `git commit` | 🟡 | 用户要求时 | **用户要求时执行** |
| `git cherry-pick` | 🟡 | 确认 SHA | 说明后执行 |
| `git commit --amend` | 🟡 | **仅未推送** | 确认未推送后执行 |
| `git merge` (到功能分支) | 🟡 | 无 | 说明后执行 |
| `git push` | 🔴 | 无 | **必须用户确认** |
| `git merge` (到 main) | 🔴 | 无 | **必须确认，建议 PR** |
| `git reset --soft/mixed` | 🔴 | 无 | **必须用户确认** |
| `git branch -d` | 🔴 | 已合并 | **必须用户确认** |
| `git branch -D` | 🔴 | 未合并 | **必须确认，警告未合并** |
| `git push origin --delete` | 🔴 | 无 | **必须用户确认** |
| `git stash drop/clear` | 🔴 | 无 | **必须用户确认** |

### 条件性操作权限

以下操作的权限取决于具体条件：

| 操作 | 条件 | 权限 |
|------|------|------|
| `git rebase` | 未推送 + 个人分支 + 用户明确要求 | 🔴 危险 (需确认) |
| `git rebase` | 已推送 或 共享分支 | ⛔ 禁止 |
| `git push --force-with-lease` | 未推送到共享分支 + 个人分支 + 用户明确确认 | 🔴 危险 |
| `git push --force` | 任何情况 | ⛔ 禁止 (建议用 --force-with-lease) |
| `git reset --hard` | 有重要未保存改动 | ⛔ 禁止 |
| `git reset --hard` | 用户明确确认丢弃 | 🔴 危险 |
| `git clean -f/-fd` | 未预览 | ⛔ 禁止 (先 -n 预览) |
| `git clean -f/-fd` | 已预览 + 用户确认 | 🔴 危险 |
| `git clean -fdx` | 任何情况 | ⛔ 禁止 |

### 流程继续/中止命令

进入某流程后的继续/中止操作，风险较低：

| 操作 | 等级 | 说明 |
|------|------|------|
| `git merge --continue` | 🟡 | 冲突解决后继续 |
| `git merge --abort` | 🟡 | 放弃合并，恢复原状 |
| `git cherry-pick --continue` | 🟡 | 冲突解决后继续 |
| `git cherry-pick --abort` | 🟡 | 放弃挑拣 |
| `git rebase --continue` | 🟡 | 冲突解决后继续 (仅限用户主动发起的 rebase) |
| `git rebase --abort` | 🟡 | 放弃变基，恢复原状 |

---

## Claude 与 Codex 分工

```
┌─────────────────────────────────────────────────────────────┐
│                        Claude 职责                          │
├─────────────────────────────────────────────────────────────┤
│ ✅ 代码编写与修改                                           │
│ ✅ 与用户交互、理解需求                                      │
│ ✅ Git 操作决策与执行                                        │
│ ✅ 识别操作时机并建议用户                                    │
│ ✅ 提交信息编写 (简短)                                       │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                        Codex 职责                           │
├─────────────────────────────────────────────────────────────┤
│ ✅ 变更日志编写 (docs/upgrades/git-upgrades.md)             │
│ ✅ 大量文本输出任务                                          │
│ ✅ 代码审查与建议                                            │
│ ✅ 复杂分析报告生成                                          │
└─────────────────────────────────────────────────────────────┘
```

### 提交流程分工

```
用户确认变更有效 → Claude 建议提交 → 用户同意 →
├── Claude: git add + git commit + git tag (如需要)
├── Codex: 编写变更日志到 docs/upgrades/git-upgrades.md
├── Claude: git add 变更日志 + git commit
└── Claude: (用户确认后) git push
```

---

## 操作触发时机识别

### 何时建议创建分支

**用户不会直接说"创建分支"，Claude 需要识别以下信号**:

| 用户可能说的话 | 识别为 | 建议操作 |
|---------------|--------|---------|
| "帮我开发一个 xxx 功能" | 新功能开发 | feature/xxx |
| "这个地方有 bug，帮我修一下" | Bug 修复 | fix/xxx |
| "帮我重构一下这个模块" | 代码重构 | refactor/xxx |
| "性能太差了，优化一下" | 性能优化 | perf/xxx |
| "数据处理流程需要调整" | 功能变更 | feature/xxx |

**Claude 决策逻辑**:

```
IF 用户描述的任务涉及:
    - 新增功能/接口/模块
    - 修复问题/Bug
    - 重构/优化
    - 预计改动 >= 3 个文件
    - 可能影响现有功能
THEN:
    1. 检查当前分支: git branch --show-current
    2. IF 当前在 main 分支:
        建议: "这个任务建议在新分支上进行，创建 feature/xxx 分支？(y/n)"
    3. IF 当前已在功能分支:
        继续在当前分支开发

不建议创建分支的情况:
├── 仅修改文档/注释/README
├── 修改单个配置项
├── 用户说"直接改"/"小改动"
├── 当前已在对应功能分支上
└── 用户明确拒绝分支建议
```

### 何时建议提交

```
默认: 完成代码编写后，不主动提交

IF 用户确认变更效果符合要求 (识别以下信号):
    - "代码能跑通了"
    - "测试通过了"
    - "功能正常了"
    - "Bug 修复了"
    - "可以了"/"没问题了"
THEN:
    Claude 建议: "变更已验证通过，是否提交？(y/n)"

IF 用户明确要求:
    - "提交一下"
    - "commit"
THEN:
    执行 git add + git commit
```

### 何时建议推送

```
触发条件:
├── 用户明确要求推送
├── 用户要求创建 PR
├── 用户说"同步到远程"
└── 用户同意 Claude 的提交建议后

Claude 永远不会主动推送，必须用户确认
询问格式: "推送到远程？(y/n)"
```

---

## 提交与变更日志流程

### 完整提交流程

当用户同意提交时：

```
1. git add .                              # 暂存改动
2. git commit -m "<type>(<scope>): <msg>" # 提交
3. (如需要) git tag -a v<version> -m "..." # 打 tag
4. (委托 Codex) 更新变更日志
5. git add docs/upgrades/git-upgrades.md # 暂存变更日志
6. git commit -m "docs: 更新变更日志"     # 提交变更日志
7. (用户确认后) git push                  # 推送
```

### Claude 建议话术

```
确认询问格式: "xxx？(y/n)"

提交建议:
"变更已验证通过，是否提交？(y/n)"

推送建议:
"当前有 N 个提交待推送，推送到远程？(y/n)"

分支建议:
"这个任务建议在新分支进行，创建 feature/xxx 分支？(y/n)"

危险操作确认:
"此操作会 [影响说明]，确认执行？(y/n)"
```

---

## 决策问句模板

当遇到需要确认的场景时，Claude 应使用以下问句：

```
1. 确认推送状态:
   "这个提交/分支是否已推送到远程？"

2. 确认分支归属:
   "这是个人分支还是共享分支 (main/develop)？"

3. 确认改写历史:
   "是否允许改写历史？这会影响已推送的提交"

4. 确认丢弃改动:
   "是否允许丢弃未提交的改动？要不要先 stash 保存？"

5. 确认撤销方式:
   "撤销是要保留历史 (revert) 还是回退状态 (reset)？"

6. 确认删除操作:
   "确认要删除分支 xxx 吗？(y/n)"

7. 确认清理范围:
   "以下文件将被删除: [文件列表]，确认吗？(y/n)"
```

---

## 提交前检查清单

Claude 在执行 `git commit` 前必须确认:

```
□ 不包含敏感信息 (密钥/密码/token)
□ 不包含调试代码 (print/console.log)
□ 不包含 IDE 配置文件
□ 提交信息符合 Conventional Commits 格式
□ 改动与提交信息描述一致
```

---

## 冲突处理

```
IF 执行 git pull/merge 出现冲突:
    1. 停止操作
    2. 报告: "发现冲突，涉及以下文件: [文件列表]"
    3. 询问: "是否需要我协助解决冲突？(y/n)"
    4. 等待用户指示
```

---

## 敏感文件检测

```
IF 暂存区包含以下文件:
    - .env / .env.*
    - *credentials*
    - *secret*
    - *.pem / *.key
    - config/**/prod*

THEN:
    警告: "检测到可能包含敏感信息的文件: [文件列表]"
    询问: "确认要提交吗？(y/n)"
    等待用户确认
```

---

## 敏感信息泄露处理

```
IF 用户说"提交了密码/密钥/token":
    1. 立即停止，不要继续推送
    2. 告知: "git revert 只能撤销内容，无法从历史中抹除"
    3. 建议: "请立即轮换泄露的密钥，并联系安全团队处理历史清除"
    4. Claude 不执行历史重写操作 (如 filter-branch)
```
